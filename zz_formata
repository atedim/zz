#!/bin/bash

# Verifica se o parted está instalado
if ! command -v parted &> /dev/null
then
    clear
    echo "O parted precisa estar instalado para executar este script."
    exit 1
fi

# Lista os discos presentes no sistema
echo "Discos disponíveis no sistema:"
DISCOS=($(lsblk -dn -o NAME,SIZE,TYPE | grep disk | awk '{print "/dev/"$1}'))
for i in "${!DISCOS[@]}"; do
    echo "$((i+1)) - ${DISCOS[i]}"
done

# Solicita a seleção do disco pelo número
read -p "Selecione o número do disco (1-${#DISCOS[@]}): " NUMERO

# Verifica se o número é válido
if [[ $NUMERO -lt 1 || $NUMERO -gt ${#DISCOS[@]} ]]; then
    echo "Número inválido. Por favor, selecione um número entre 1 e ${#DISCOS[@]}."
    exit 1
fi

DISCO=${DISCOS[$((NUMERO-1))]}

# Verifica se o disco está montado
MONTADO=$(lsblk -o MOUNTPOINT -nr "$DISCO" | grep -v "^$")

if [ -n "$MONTADO" ]; then
    echo "O disco $DISCO está montado em $MONTADO. Tentando desmontar..."
    umount "$DISCO"* 2>/dev/null
    
    # Verifica se o disco foi desmontado com sucesso
    MONTADO=$(lsblk -o MOUNTPOINT -nr "$DISCO" | grep -v "^$")
    if [ -n "$MONTADO" ]; then
        echo "Erro: Não foi possível desmontar o disco $DISCO. Abortando."
        exit 1
    else
        echo "Disco $DISCO desmontado com sucesso."
    fi
else
    echo "O disco $DISCO já está desmontado."
fi

# Solicita o nome do disco
read -p "Informe o nome do disco: " NOMEDODISCO

# Exibe o tamanho total utilizável do disco
TAMANHO_DISCO=$(lsblk -b -dn -o SIZE "$DISCO")
TAMANHO_DISCO_GB=$((TAMANHO_DISCO / 1024 / 1024 / 1024))
echo "O tamanho total utilizável do disco $DISCO é de $TAMANHO_DISCO_GB GB."

# Remove assinaturas anteriores
echo "Limpando o disco $DISCO..."
wipefs -a -f "$DISCO"

# Cria a partição GPT usando o parted
echo "Criando partição GPT no $DISCO..."
parted "$DISCO" mklabel gpt
parted "$DISCO" mkpart primary ext4 0% 100%

# Formata a partição com ext4
PARTICAO="${DISCO}1"
echo "Formatando a partição $PARTICAO com ext4..."
mkfs.ext4 -j -F -L "$NOMEDODISCO" -m 0 "$PARTICAO"

# Exibe mensagem de conclusão
echo "Disco $NOMEDODISCO formatado com sucesso no $PARTICAO."
