#!/bin/bash

#############################################################
#  ZZ_RAMLOADER - Carrega scripts em RAM Disk (tmpfs)
#############################################################

[ "$EUID" -ne 0 ] && {
    echo "Este script precisa ser executado como root."
    exit 1
}

modo_silent="nao"
modo_debug="nao"
modo_umount="nao"

for arg in "$@"; do
    [ "$arg" = "-s" ] && modo_silent="sim"
    [ "$arg" = "-silent" ] && modo_silent="sim"
    [ "$arg" = "-debug" ] && modo_debug="sim"
    [ "$arg" = "-umount" ] && modo_umount="sim"
done

set -Ee

trap 'cleanup_on_error $? $LINENO "$BASH_COMMAND"' ERR

#########################
# VARIÁVEIS
#########################

tamanho_ramdisk="64M"
localidade="/mnt"
ponto_montagem="$localidade/ram_scripts"

url_tgz="https://www.grupoalbatroz.com.br/teste.tgz"
url_tgz_backup="https://backup.grupoalbatroz.com.br/teste.tgz"

retry=3

sha256_esperado="4FF032B17663528F5F613D1F823DEF08632FEFD1453CD35DB7850666D15C3243"

arquivo_tgz="$ponto_montagem/pacote.tgz"
log="/var/log/zz_ramloader.log"

#########################
# LOG
#########################

log_info() {
    msg="$(date '+%F %T') [INFO] $1"
    [ "$modo_silent" = "sim" ] && echo "$msg" >> "$log" || echo "$msg" | tee -a "$log"
}

log_erro() {
    msg="$(date '+%F %T') [ERRO] $1"
    [ "$modo_silent" = "sim" ] && echo "$msg" >> "$log" || echo "$msg" | tee -a "$log"
    exit 1
}

cleanup_on_error() {

    if [ "$modo_debug" = "sim" ]; then
        log_info "DEBUG: Código: $1 Linha: $2 Comando: $3"
    fi

    log_info "Erro detectado. Limpando..."

    if mountpoint -q "$ponto_montagem"; then
        umount "$ponto_montagem"
    fi

    exit 1
}

#########################
# DESMONTAGEM SEGURA
#########################

executa_umount_seguro() {

    log_info "Solicitada desmontagem manual (-umount)."

    if mountpoint -q "$ponto_montagem"; then

        sync

        if umount "$ponto_montagem"; then
            log_info "RAM Disk desmontado com sucesso."
        else
            log_erro "Falha ao desmontar RAM Disk."
        fi

    else
        log_info "RAM Disk não está montado."
    fi

    exit 0
}

#########################
# VERIFICA RAM DISPONÍVEL
#########################

verifica_memoria_disponivel() {

    log_info "Verificando memória RAM disponível..."

    ram_disponivel_kb=$(awk '/MemAvailable/ {print $2}' /proc/meminfo)
    ram_disponivel_bytes=$((ram_disponivel_kb * 1024))

    tamanho_bytes=$(numfmt --from=iec "$tamanho_ramdisk")

    log_info "RAM disponível: $ram_disponivel_bytes bytes"
    log_info "RAM necessária para tmpfs: $tamanho_bytes bytes"

    if [ "$ram_disponivel_bytes" -lt "$tamanho_bytes" ]; then
        log_erro "Memória insuficiente para montar RAM Disk."
    fi
}

#########################
# LIMPEZA SEGURA
#########################

limpa_ambiente_inicial() {

    if mountpoint -q "$ponto_montagem"; then
        umount "$ponto_montagem"
    fi

    if [ -n "$ponto_montagem" ] && [ -d "$ponto_montagem" ]; then
        rm -rf "${ponto_montagem:?}"/*
    fi

    mkdir -p "$ponto_montagem"
}

#########################
# MONTAGEM
#########################

monta_ramdisk() {
    mount -t tmpfs -o size="$tamanho_ramdisk" tmpfs "$ponto_montagem"
}

#########################
# DOWNLOAD
#########################

download_com_retry() {

    tentativa=1
    sucesso="nao"

    log_info "Iniciando download pela URL principal..."

    while [ "$tentativa" -le "$retry" ]; do

        log_info "Tentativa $tentativa de $retry (principal)"

        if [ "$modo_silent" = "sim" ]; then
            wget -q --timeout=15 --tries=2 -O "$arquivo_tgz" "$url_tgz" >> "$log" 2>&1
        else
            wget --timeout=15 --tries=2 -O "$arquivo_tgz" "$url_tgz"
        fi

        if [ $? -eq 0 ]; then
            sucesso="sim"
            break
        fi

        tentativa=$((tentativa + 1))
        sleep 2
    done

    if [ "$sucesso" = "nao" ]; then

        log_info "Falha na URL principal. Tentando backup..."

        tentativa=1

        while [ "$tentativa" -le "$retry" ]; do

            log_info "Tentativa $tentativa de $retry (backup)"

            if [ "$modo_silent" = "sim" ]; then
                wget -q --timeout=15 --tries=2 -O "$arquivo_tgz" "$url_tgz_backup" >> "$log" 2>&1
            else
                wget --timeout=15 --tries=2 -O "$arquivo_tgz" "$url_tgz_backup"
            fi

            if [ $? -eq 0 ]; then
                sucesso="sim"
                break
            fi

            tentativa=$((tentativa + 1))
            sleep 2
        done
    fi

    if [ "$sucesso" = "nao" ]; then
        log_erro "Falha no download após todas tentativas."
    fi
}

#########################
# VALIDA HASH
#########################

valida_hash() {

    log_info "Validando SHA256..."

    sha256_normalizado=$(echo "$sha256_esperado" | tr '[:upper:]' '[:lower:]')

    if ! echo "$sha256_normalizado" | grep -qE '^[0-9a-f]{64}$'; then
        log_erro "SHA256 informado é inválido ou mal formatado."
    fi

    if ! echo "$sha256_normalizado  $arquivo_tgz" | sha256sum -c - >/dev/null 2>&1; then
        rm -f "$arquivo_tgz"
        log_erro "SHA256 inválido."
    fi

    log_info "SHA256 validado com sucesso."
}

#########################
# VERIFICA TAMANHO REAL
#########################

verifica_tamanho_real() {

    log_info "Verificando tamanho real para extração..."

    tamanho_tgz=$(stat -c%s "$arquivo_tgz")

    tamanho_expandido=$(tar -tzvf "$arquivo_tgz" | awk '{s+=$3} END {print s}')

    tamanho_total=$((tamanho_tgz + tamanho_expandido))

    tamanho_tmpfs=$(df -B1 "$ponto_montagem" | awk 'NR==2 {print $2}')

    log_info "TGZ: $tamanho_tgz bytes"
    log_info "Expandido: $tamanho_expandido bytes"
    log_info "Total necessário: $tamanho_total bytes"
    log_info "Tamanho RAM Disk: $tamanho_tmpfs bytes"

    if [ "$tamanho_total" -gt "$tamanho_tmpfs" ]; then
        log_erro "RAM Disk insuficiente para extração."
    fi
}

#########################
# EXTRAÇÃO
#########################

extrai_tgz() {
    tar -xzf "$arquivo_tgz" -C "$ponto_montagem"
    rm -f "$arquivo_tgz"
}

#########################
# EXECUÇÃO
#########################

# Se for solicitado apenas desmontar
[ "$modo_umount" = "sim" ] && executa_umount_seguro

verifica_memoria_disponivel
limpa_ambiente_inicial
monta_ramdisk
download_com_retry
valida_hash
verifica_tamanho_real
extrai_tgz

log_info "Processo concluído com sucesso."
