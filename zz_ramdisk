#!/bin/bash

#############################################################
#  ZZ_RAMLOADER - Carrega scripts em RAM Disk (tmpfs)
#############################################################

#########################
# PROTEÇÃO ROOT
#########################

[ "$EUID" -ne 0 ] && {
    echo "Este script precisa ser executado como root."
    exit 1
}

#########################
# PARÂMETROS
#########################

modo_silent="nao"
modo_debug="nao"

for arg in "$@"; do
    [ "$arg" = "-s" ] && modo_silent="sim"
    [ "$arg" = "-silent" ] && modo_silent="sim"
    [ "$arg" = "-debug" ] && modo_debug="sim"
done

#########################
# CONTROLE DE ERROS
#########################

set -Ee

cleanup_on_error() {

    codigo="$1"
    linha="$2"
    comando="$3"

    if [ "$modo_debug" = "sim" ]; then
        log_info "DEBUG: Código erro: $codigo"
        log_info "DEBUG: Linha: $linha"
        log_info "DEBUG: Comando: $comando"
    fi

    log_info "Erro detectado. Executando limpeza automática..."

    if mountpoint -q "$ponto_montagem"; then
        tipo_fs=$(df -T "$ponto_montagem" | awk 'NR==2 {print $2}')
        if [ "$tipo_fs" = "tmpfs" ]; then
            log_info "Desmontando RAM Disk devido a erro..."
            umount "$ponto_montagem"
        fi
    fi

    exit 1
}

trap 'cleanup_on_error $? $LINENO "$BASH_COMMAND"' ERR

#########################
# VARIÁVEIS
#########################

tamanho_ramdisk="64M"
localidade="/mnt"
ponto_montagem="$localidade/ram_scripts"

url_tgz="https://www.grupoalbatroz.com.br/teste.tgz"
url_tgz_backup="https://backup.grupoalbatroz.com.br/teste.tgz"

retry=3

sha256_esperado="4FF032B17663528F5F613D1F823DEF08632FEFD1453CD35DB7850666D15C3243"

arquivo_tgz="$ponto_montagem/pacote.tgz"
log="/var/log/zz_ramloader.log"

#########################
# LOG
#########################

log_info() {

    mensagem="$(date '+%F %T') [INFO] $1"

    if [ "$modo_silent" = "sim" ]; then
        echo "$mensagem" >> "$log"
    else
        echo "$mensagem" | tee -a "$log"
    fi
}

log_erro() {

    mensagem="$(date '+%F %T') [ERRO] $1"

    if [ "$modo_silent" = "sim" ]; then
        echo "$mensagem" >> "$log"
    else
        echo "$mensagem" | tee -a "$log"
    fi

    exit 1
}

#########################
# DEPENDÊNCIAS
#########################

verifica_dependencias() {

    log_info "Verificando dependências..."

    for cmd in mount umount wget tar df awk sha256sum mountpoint rm mkdir sleep tr grep; do
        command -v "$cmd" >/dev/null 2>&1 || log_erro "Dependência '$cmd' não encontrada."
    done

    log_info "Dependências OK."
}

#########################
# LIMPEZA INICIAL
#########################

limpa_ambiente_inicial() {

    log_info "Verificando ambiente inicial..."

    if mountpoint -q "$ponto_montagem"; then

        tipo_fs=$(df -T "$ponto_montagem" | awk 'NR==2 {print $2}')

        if [ "$tipo_fs" = "tmpfs" ]; then
            log_info "RAM Disk detectado. Desmontando..."
            umount "$ponto_montagem"
        else
            log_erro "Existe algo montado que NÃO é tmpfs."
        fi
    fi

    if [ -d "$ponto_montagem" ]; then
        log_info "Limpando diretório $ponto_montagem"
        rm -rf "$ponto_montagem"/*
    fi

    mkdir -p "$ponto_montagem"
    log_info "Ambiente limpo."
}

#########################
# MONTAGEM
#########################

monta_ramdisk() {

    log_info "Montando RAM Disk $tamanho_ramdisk em $ponto_montagem"
    mount -t tmpfs -o size="$tamanho_ramdisk" tmpfs "$ponto_montagem"
}

valida_tmpfs() {

    tipo_fs=$(df -T "$ponto_montagem" | awk 'NR==2 {print $2}')
    [ "$tipo_fs" = "tmpfs" ] || log_erro "Destino não é tmpfs."
}

#########################
# DOWNLOAD COM RETRY + FAILOVER
#########################

download_com_retry() {

    tentativa=1
    sucesso="nao"

    log_info "Iniciando download pela URL principal..."

    while [ "$tentativa" -le "$retry" ]; do

        log_info "Tentativa $tentativa de $retry (principal)"

        if wget -O "$arquivo_tgz" "$url_tgz"; then
            sucesso="sim"
            break
        fi

        tentativa=$((tentativa + 1))
        sleep 2
    done

    if [ "$sucesso" = "nao" ]; then

        log_info "Falha na URL principal. Tentando backup..."

        tentativa=1

        while [ "$tentativa" -le "$retry" ]; do

            log_info "Tentativa $tentativa de $retry (backup)"

            if wget -O "$arquivo_tgz" "$url_tgz_backup"; then
                sucesso="sim"
                break
            fi

            tentativa=$((tentativa + 1))
            sleep 2
        done
    fi

    if [ "$sucesso" = "nao" ]; then
        log_erro "Falha no download após todas tentativas."
    fi
}
#########################
# VALIDA HASH (ROBUSTO)
#########################

valida_hash() {

    log_info "Validando SHA256..."

    # Normaliza hash esperado
    sha256_normalizado=$(echo "$sha256_esperado" | tr '[:upper:]' '[:lower:]')

    # Valida formato do hash esperado
    if ! echo "$sha256_normalizado" | grep -qE '^[0-9a-f]{64}$'; then
        log_erro "SHA256 informado é inválido ou mal formatado."
    fi

    # Calcula e normaliza hash do arquivo
    sha256_calculado=$(sha256sum "$arquivo_tgz" | awk '{print $1}' | tr '[:upper:]' '[:lower:]')

    if [ "$sha256_calculado" != "$sha256_normalizado" ]; then
        rm -f "$arquivo_tgz"
        log_erro "SHA256 inválido."
    fi

    log_info "SHA256 validado com sucesso."
}

#########################
# EXTRAÇÃO
#########################

extrai_tgz() {

    log_info "Extraindo pacote..."
    tar -xzf "$arquivo_tgz" -C "$ponto_montagem"

    log_info "Removendo arquivo compactado..."
    rm -f "$arquivo_tgz"
}

#########################
# EXECUÇÃO
#########################

verifica_dependencias
limpa_ambiente_inicial
monta_ramdisk
valida_tmpfs
download_com_retry
valida_hash
extrai_tgz

log_info "Processo concluído com sucesso."
