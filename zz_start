#!/bin/bash

# Caminhos e vari√°veis globais
caminho_scripts="/etc/scripts"
log_dir="$caminho_scripts/logs"
data_hora=$(date +"%d%m%Y-%H%M")
log_file="$log_dir/zz_start_$data_hora.log"
max_retentativas=3  # <- N√∫mero de tentativas para comandos cr√≠ticos

# Redireciona stdout e stderr para o log
mkdir -p "$log_dir"
exec > >(tee -a "$log_file") 2>&1

# Verifica se √© root
if [[ $EUID -ne 0 ]]; then
  echo "‚ùå Este script precisa ser executado como root."
  exit 1
fi
echo "‚úÖ Execu√ß√£o iniciada como root."

# Cria√ß√£o dos diret√≥rios
echo "ﬂì Criando diret√≥rios padr√£o..."
mkdir -p "$caminho_scripts" "$log_dir" "$caminho_scripts/bkp_configs"
if [[ $? -ne 0 ]]; then
  echo "‚ùå Erro ao criar diret√≥rios."
  exit 1
else
  echo "‚úÖ Diret√≥rios criados/verificados com sucesso."
fi

# Fun√ß√£o de retentativa
retry() {
  local tentativas=0
  local max=$max_retentativas
  until "$@"; do
    tentativas=$((tentativas+1))
    if [[ $tentativas -ge $max ]]; then
      echo "‚ùå Falha ap√≥s $max tentativas: $*"
      return 1
    fi
    echo "‚Ü™Ô∏è Tentando novamente ($tentativas/$max)..."
    sleep 2
  done
  return 0
}

# Atualiza√ß√£o do sistema
echo "ﬂî Atualizando pacotes..."
retry apt-get update -y -qq && retry apt-get upgrade -y -qq
if [[ $? -ne 0 ]]; then
  echo "‚ùå Falha ao atualizar o sistema."
  exit 1
else
  echo "‚úÖ Sistema atualizado com sucesso."
fi

# Lista de pacotes
PACOTES="bmon htop rclone rsync sshpass dos2unix mc msmtp msmtp-mta sharutils ntpdate curl bc rcconf cifs-utils samba mergerfs iptraf-ng net-tools gdu etherwake screen mdadm parted mime-construct"

# Instala√ß√£o de pacotes
echo "ﬂî Instalando pacotes..."
retry apt-get install -y -qq $PACOTES
if [[ $? -ne 0 ]]; then
  echo "‚ùå Falha na instala√ß√£o dos pacotes."
  exit 1
else
  echo "‚úÖ Pacotes instalados com sucesso."
fi

# Sincroniza√ß√£o de hora
echo "ﬂï Sincronizando data/hora..."
ntpdate pool.ntp.org >/dev/null 2>&1 && echo "‚úÖ Hora sincronizada." || echo "‚ö†Ô∏è Falha na sincroniza√ß√£o NTP (ignorado)"

# Baixar scripts
cd /tmp || { echo "‚ùå Falha ao acessar /tmp"; exit 1; }

echo "‚¨áÔ∏è Baixando zz_ini..."
retry wget -q -O zz_ini https://raw.githubusercontent.com/atedim/zz/main/ini/zz_ini
echo "‚úÖ zz_ini baixado com sucesso."

echo "‚¨áÔ∏è Baixando zz_down..."
retry wget -q -O zz_down https://raw.githubusercontent.com/atedim/zz/main/down/zz_down
echo "‚úÖ zz_down baixado com sucesso."

echo "‚¨áÔ∏è Baixando zz_down.ini..."
retry wget -q -O zz_down.ini https://raw.githubusercontent.com/atedim/zz/main/down/zz_down.ini
echo "‚úÖ zz_down.ini baixado com sucesso."

# Mover arquivos
echo "ﬂì Movendo arquivos para $caminho_scripts..."
mv zz_ini zz_down zz_down.ini "$caminho_scripts/"
echo "‚úÖ Arquivos movidos com sucesso."

# Permiss√µes
echo "ﬂî Ajustando permiss√µes..."
chmod +x "$caminho_scripts/zz_down" "$caminho_scripts/zz_ini"
chown root:root -R "$caminho_scripts"
echo "‚úÖ Permiss√µes aplicadas com sucesso."

# Corrigir finalizadores de linha
echo "ﬂî Corrigindo finalizadores de linha..."
dos2unix "$caminho_scripts/zz_down" "$caminho_scripts/zz_ini" >/dev/null 2>&1
echo "‚úÖ Corre√ß√µes aplicadas."

# PATH no .bashrc
if ! grep -q "$caminho_scripts" ~/.bashrc; then
  echo "ﬂî Adicionando $caminho_scripts ao PATH..."
  echo -e "\n# Adicionado por script de instala√ß√£o\nexport PATH=\$PATH:$caminho_scripts" >> ~/.bashrc
  echo "‚úÖ Caminho adicionado ao PATH no .bashrc."
else
  echo "‚ÑπÔ∏è Caminho $caminho_scripts j√° presente no PATH do .bashrc."
fi

# Exporta PATH para sess√£o atual
echo "ﬂî Exportando PATH para sess√£o atual..."
export PATH="$PATH:$caminho_scripts"
hash -r
echo "‚úÖ Caminho dispon√≠vel nesta sess√£o."

echo "üìÑ Log completo salvo em: $log_file"
echo "ﬂé Script finalizado com sucesso! REINICIE o sistema para aplicar completamente !"
