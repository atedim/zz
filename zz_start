#!/bin/bash
set -e

# Caminho dos scripts e log
caminho_scripts="/etc/scripts"
log_file="$caminho_scripts/logs/install.log"

# CriaÃ§Ã£o inicial das pastas necessÃ¡rias
mkdir -p "$caminho_scripts/logs" "$caminho_scripts/bkp_configs"

# InÃ­cio do log
exec > >(tee -a "$log_file") 2>&1

# FunÃ§Ã£o de retentativa
retry() {
  local tries=$1
  shift
  local n=1
  until "$@"; do
    if [[ $n -lt $tries ]]; then
      echo "âš ï¸ Tentativa $n falhou. Retentando..."
      ((n++))
      sleep 2
    else
      echo "âŒ Comando falhou apÃ³s $tries tentativas: $*"
      return 1
    fi
  done
}

# Verifica se Ã© root
if [[ $EUID -ne 0 ]]; then
  echo "âŒ Este script precisa ser executado como root."
  exit 1
fi
echo "âœ… ExecuÃ§Ã£o iniciada como root."

# AtualizaÃ§Ã£o do sistema
echo "ğŸ”„ Atualizando pacotes..."
retry 3 apt-get  update -y -qq
retry 3 apt-get  upgrade -y -qq
echo "âœ… Sistema atualizado com sucesso."

# Lista de pacotes
PACOTES="bmon htop rclone rsync sshpass dos2unix mc msmtp msmtp-mta sharutils ntpdate curl bc rcconf cifs-utils samba mergerfs iptraf-ng net-tools gdu etherwake screen mdadm parted mime-construct"

# InstalaÃ§Ã£o de pacotes
echo "ğŸ”„ Instalando pacotes..."
retry 3 apt-get  install -y -qq $PACOTES
echo "âœ… Pacotes instalados com sucesso."

# SincronizaÃ§Ã£o de hora
echo "ğŸ•’ Sincronizando data/hora com pool.ntp.org..."
ntpdate pool.ntp.org >/dev/null 2>&1 || echo "âš ï¸ Falha na sincronizaÃ§Ã£o NTP (ignorado)"

# Download dos arquivos
cd /tmp || { echo "âŒ Falha ao acessar /tmp"; exit 1; }

echo "â¬‡ï¸ Baixando zz_ini..."
retry 3 wget -q -O zz_ini https://raw.githubusercontent.com/atedim/zz/main/ini/zz_ini && echo "âœ… zz_ini baixado com sucesso."

echo "â¬‡ï¸ Baixando zz_down..."
retry 3 wget -q -O zz_down https://raw.githubusercontent.com/atedim/zz/main/down/zz_down && echo "âœ… zz_down baixado com sucesso."

echo "â¬‡ï¸ Baixando zz_down.ini..."
retry 3 wget -q -O zz_down.ini https://raw.githubusercontent.com/atedim/zz/main/down/zz_down.ini && echo "âœ… zz_down.ini baixado com sucesso."

# Movendo arquivos
echo "ğŸ“¦ Movendo arquivos para $caminho_scripts..."
mv zz_ini zz_down zz_down.ini "$caminho_scripts/" && echo "âœ… Arquivos movidos com sucesso."

# PermissÃµes
echo "ğŸ” Ajustando permissÃµes..."
chmod +x "$caminho_scripts/zz_down" "$caminho_scripts/zz_ini"
chown root:root -R "$caminho_scripts"
echo "âœ… PermissÃµes aplicadas com sucesso."

# Ajuste de CRLF
echo "ğŸ“ Ajustando finalizador de linha..."
dos2unix "$caminho_scripts/zz_down" >/dev/null 2>&1
dos2unix "$caminho_scripts/zz_ini"  >/dev/null 2>&1
echo "âœ… Ajustes aplicados com sucesso."

# PATH no .bashrc
if ! grep -q "$caminho_scripts" ~/.bashrc; then
  echo "ğŸ”§ Adicionando $caminho_scripts ao PATH no .bashrc..."
  echo -e "\n# Adicionado por script de instalaÃ§Ã£o\nexport PATH=\$PATH:$caminho_scripts" >> ~/.bashrc
  echo "âœ… Caminho adicionado ao PATH no .bashrc."
else
  echo "â„¹ï¸ Caminho $caminho_scripts jÃ¡ estÃ¡ presente no PATH do .bashrc."
fi

# Exporta PATH na sessÃ£o atual
echo "ğŸ”„ Exportando PATH para sessÃ£o atual..."
export PATH="$PATH:$caminho_scripts"
hash -r
echo "âœ… Caminho $caminho_scripts disponÃ­vel imediatamente nesta sessÃ£o."

echo "ğŸ‰ Script finalizado com sucesso! NecessÃ¡rio REBOOT para pleno funcionamento !!"
