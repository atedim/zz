#!/bin/bash
set -e

# Caminho dos scripts
caminho_scripts="/etc/scripts"

# Verifica se é root
if [[ $EUID -ne 0 ]]; then
  echo "❌ Este script precisa ser executado como root."
  exit 1
fi

echo "✅ Execução iniciada como root."

# Atualização do sistema
echo "🔄 Atualizando pacotes..."
apt update -y && apt upgrade -y
echo "✅ Sistema atualizado com sucesso."

# Lista de pacotes a instalar
PACOTES="bmon htop rclone rsync sshpass dos2unix mc msmtp msmtp-mta sharutils ntpdate curl bc rcconf cifs-utils samba mergerfs iptraf-ng net-tools gdu etherwake screen mdadm parted mime-construct"

# Instalação dos pacotes
echo "🔄 Instalando pacotes..."
apt install -y $PACOTES
echo "✅ Pacotes instalados com sucesso."

# Ajusta data e hora do sistema
echo "🕒 Sincronizando data/hora com pool.ntp.org..."
ntpdate pool.ntp.org >/dev/null || echo "⚠️ Falha na sincronização NTP (ignorado)"

# Criação dos diretórios
echo "📁 Verificando/criando diretórios..."
mkdir -p "$caminho_scripts" "$caminho_scripts/log" "$caminho_scripts/bkp_configs"
echo "✅ Diretórios criados/verificados com sucesso."

# Download dos arquivos
cd /tmp || { echo "❌ Falha ao acessar /tmp"; exit 1; }

echo "⬇️ Baixando zz_ini..."
wget -q -O zz_ini https://raw.githubusercontent.com/atedim/zz/main/ini/zz_ini
echo "✅ zz_ini baixado com sucesso."

echo "⬇️ Baixando zz_down..."
wget -q -O zz_down https://raw.githubusercontent.com/atedim/zz/main/down/zz_down
echo "✅ zz_down baixado com sucesso."

echo "⬇️ Baixando zz_down.ini..."
wget -q -O zz_down.ini https://raw.githubusercontent.com/atedim/zz/main/down/zz_down.ini
echo "✅ zz_down.ini baixado com sucesso."

# Move os arquivos
echo "📦 Movendo arquivos para $caminho_scripts..."
mv zz_ini zz_down zz_down.ini "$caminho_scripts/"
echo "✅ Arquivos movidos com sucesso."

# Permissões
echo "🔐 Ajustando permissões..."
chmod +x "$caminho_scripts/zz_down"
chmod +x "$caminho_scripts/zz_ini"
chown root:root -R "$caminho_scripts"
echo "✅ Permissões aplicadas com sucesso."

# Adiciona /etc/scripts ao PATH no .bashrc se ainda não estiver
if ! grep -q "$caminho_scripts" ~/.bashrc; then
  echo "🔧 Adicionando $caminho_scripts ao PATH no .bashrc..."
  echo -e "\n# Adicionado por script de instalação\nexport PATH=\$PATH:$caminho_scripts" >> ~/.bashrc
  echo "✅ Caminho adicionado ao PATH no .bashrc."
else
  echo "ℹ️ Caminho $caminho_scripts já está presente no PATH do .bashrc."
fi

# Adiciona ao PATH na sessão atual
echo "🔄 Exportando PATH para sessão atual..."
export PATH="$PATH:$caminho_scripts"
hash -r
echo "✅ Caminho $caminho_scripts disponível imediatamente nesta sessão."

echo "🎉 Script finalizado com sucesso!"
