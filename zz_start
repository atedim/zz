#!/bin/bash
set -e

# Caminho dos scripts
caminho_scripts="/etc/scripts"

# Verifica se Ã© root
if [[ $EUID -ne 0 ]]; then
  echo "âŒ Este script precisa ser executado como root."
  exit 1
fi

echo "âœ… ExecuÃ§Ã£o iniciada como root."

# AtualizaÃ§Ã£o do sistema
echo "ğŸ”„ Atualizando pacotes..."
apt update -y && apt upgrade -y
echo "âœ… Sistema atualizado com sucesso."

# Lista de pacotes a instalar
PACOTES="bmon htop rclone rsync sshpass dos2unix mc msmtp msmtp-mta sharutils ntpdate curl bc rcconf cifs-utils samba mergerfs iptraf-ng net-tools gdu etherwake screen mdadm parted mime-construct"

# InstalaÃ§Ã£o dos pacotes
echo "ğŸ”„ Instalando pacotes..."
apt install -y $PACOTES
echo "âœ… Pacotes instalados com sucesso."

# Ajusta data e hora do sistema
echo "ğŸ•’ Sincronizando data/hora com pool.ntp.org..."
ntpdate pool.ntp.org >/dev/null || echo "âš ï¸ Falha na sincronizaÃ§Ã£o NTP (ignorado)"

# CriaÃ§Ã£o dos diretÃ³rios
echo "ğŸ“ Verificando/criando diretÃ³rios..."
mkdir -p "$caminho_scripts" "$caminho_scripts/log" "$caminho_scripts/bkp_configs"
echo "âœ… DiretÃ³rios criados/verificados com sucesso."

# Download dos arquivos
cd /tmp || { echo "âŒ Falha ao acessar /tmp"; exit 1; }

echo "â¬‡ï¸ Baixando zz_ini..."
wget -q -O zz_ini https://raw.githubusercontent.com/atedim/zz/main/ini/zz_ini
echo "âœ… zz_ini baixado com sucesso."

echo "â¬‡ï¸ Baixando zz_down..."
wget -q -O zz_down https://raw.githubusercontent.com/atedim/zz/main/down/zz_down
echo "âœ… zz_down baixado com sucesso."

echo "â¬‡ï¸ Baixando zz_down.ini..."
wget -q -O zz_down.ini https://raw.githubusercontent.com/atedim/zz/main/down/zz_down.ini
echo "âœ… zz_down.ini baixado com sucesso."

# Move os arquivos
echo "ğŸ“¦ Movendo arquivos para $caminho_scripts..."
mv zz_ini zz_down zz_down.ini "$caminho_scripts/"
echo "âœ… Arquivos movidos com sucesso."

# PermissÃµes
echo "ğŸ” Ajustando permissÃµes..."
chmod +x "$caminho_scripts/zz_down"
chmod +x "$caminho_scripts/zz_ini"
chown root:root -R "$caminho_scripts"
echo "âœ… PermissÃµes aplicadas com sucesso."

# Adiciona /etc/scripts ao PATH no .bashrc se ainda nÃ£o estiver
if ! grep -q "$caminho_scripts" ~/.bashrc; then
  echo "ğŸ”§ Adicionando $caminho_scripts ao PATH no .bashrc..."
  echo -e "\n# Adicionado por script de instalaÃ§Ã£o\nexport PATH=\$PATH:$caminho_scripts" >> ~/.bashrc
  echo "âœ… Caminho adicionado ao PATH no .bashrc."
else
  echo "â„¹ï¸ Caminho $caminho_scripts jÃ¡ estÃ¡ presente no PATH do .bashrc."
fi

# Adiciona ao PATH na sessÃ£o atual
echo "ğŸ”„ Exportando PATH para sessÃ£o atual..."
export PATH="$PATH:$caminho_scripts"
hash -r
echo "âœ… Caminho $caminho_scripts disponÃ­vel imediatamente nesta sessÃ£o."

echo "ğŸ‰ Script finalizado com sucesso!"
