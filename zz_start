#!/bin/bash

# Caminhos e variÃ¡veis globais
caminho_scripts="/etc/scripts"
log_dir="$caminho_scripts/logs"
data_hora=$(date +"%d%m%Y-%H%M")
log_file="$log_dir/zz_start_$data_hora.log"
max_retentativas=3  # NÃºmero de tentativas para comandos crÃ­ticos

# Redireciona stdout e stderr para o log
mkdir -p "$log_dir"
exec > >(tee -a "$log_file") 2>&1

# Verifica se Ã© root
if [[ $EUID -ne 0 ]]; then
  echo "âŒ Este script precisa ser executado como root."
  exit 1
fi
echo "âœ… ExecuÃ§Ã£o iniciada como root."

# CriaÃ§Ã£o dos diretÃ³rios
echo "ğŸ“ Criando diretÃ³rios padrÃ£o..."
mkdir -p "$caminho_scripts" "$log_dir" "$caminho_scripts/bkp_configs"
if [[ $? -ne 0 ]]; then
  echo "âŒ Erro ao criar diretÃ³rios."
  exit 1
else
  echo "âœ… DiretÃ³rios criados/verificados com sucesso."
fi

# FunÃ§Ã£o de retentativa
retry() {
  local tentativas=0
  local max=$max_retentativas
  until "$@"; do
    tentativas=$((tentativas+1))
    if [[ $tentativas -ge $max ]]; then
      echo "âŒ Falha apÃ³s $max tentativas: $*"
      return 1
    fi
    echo "ğŸ” Tentando novamente ($tentativas/$max)..."
    sleep 2
  done
  return 0
}

# AtualizaÃ§Ã£o do sistema
echo "ğŸ› ï¸ Atualizando pacotes..."
retry apt-get update -y -qq && retry apt-get upgrade -y -qq
if [[ $? -ne 0 ]]; then
  echo "âŒ Falha ao atualizar o sistema."
  exit 1
else
  echo "âœ… Sistema atualizado com sucesso."
fi

# Lista de pacotes
PACOTES="bmon htop rclone rsync sshpass dos2unix mc msmtp msmtp-mta sharutils ntpdate curl bc rcconf cifs-utils samba mergerfs iptraf-ng net-tools gdu etherwake screen mdadm parted mime-construct"

# InstalaÃ§Ã£o de pacotes
echo "ğŸ“¦ Instalando pacotes..."
retry apt-get install -y -qq $PACOTES
if [[ $? -ne 0 ]]; then
  echo "âŒ Falha na instalaÃ§Ã£o dos pacotes."
  exit 1
else
  echo "âœ… Pacotes instalados com sucesso."
fi

# SincronizaÃ§Ã£o de hora
echo "â±ï¸ Sincronizando data/hora..."
ntpdate pool.ntp.org >/dev/null 2>&1 && echo "âœ… Hora sincronizada." || echo "âš ï¸ Falha na sincronizaÃ§Ã£o NTP (ignorado)"

# Baixar scripts
cd /tmp || { echo "âŒ Falha ao acessar /tmp"; exit 1; }

echo "â¬‡ï¸ Baixando zz_ini..."
retry wget -q -O zz_ini https://raw.githubusercontent.com/atedim/zz/main/ini/zz_ini
echo "âœ… zz_ini baixado com sucesso."

echo "â¬‡ï¸ Baixando zz_down..."
retry wget -q -O zz_down https://raw.githubusercontent.com/atedim/zz/main/down/zz_down
echo "âœ… zz_down baixado com sucesso."

echo "â¬‡ï¸ Baixando zz_down.ini..."
retry wget -q -O zz_down.ini https://raw.githubusercontent.com/atedim/zz/main/down/zz_down.ini
echo "âœ… zz_down.ini baixado com sucesso."

# Mover arquivos
echo "ğŸ“‚ Movendo arquivos para $caminho_scripts..."
mv zz_ini zz_down zz_down.ini "$caminho_scripts/"
echo "âœ… Arquivos movidos com sucesso."

# PermissÃµes
echo "ğŸ”’ Ajustando permissÃµes..."
chmod +x "$caminho_scripts/zz_down" "$caminho_scripts/zz_ini"
chown root:root -R "$caminho_scripts"
echo "âœ… PermissÃµes aplicadas com sucesso."

# Corrigir finalizadores de linha
echo "ğŸ§¹ Corrigindo finalizadores de linha..."
dos2unix "$caminho_scripts/zz_down" "$caminho_scripts/zz_ini" >/dev/null 2>&1
echo "âœ… CorreÃ§Ãµes aplicadas."

# PATH no .bashrc
if ! grep -q "$caminho_scripts" ~/.bashrc; then
  echo "â• Adicionando $caminho_scripts ao PATH..."
  echo -e "\n# Adicionado por script de instalaÃ§Ã£o\nexport PATH=\$PATH:$caminho_scripts" >> ~/.bashrc
  echo "âœ… Caminho adicionado ao PATH no .bashrc."
else
  echo "â„¹ï¸ Caminho $caminho_scripts jÃ¡ presente no PATH do .bashrc."
fi

# Exporta PATH para sessÃ£o atual
echo "ğŸ”„ Exportando PATH para sessÃ£o atual..."
export PATH="$PATH:$caminho_scripts"
hash -r
echo "âœ… Caminho disponÃ­vel nesta sessÃ£o."

echo "ğŸ“ Log completo salvo em: $log_file"
echo "âœ… Script finalizado com sucesso! ğŸ” REINICIE o sistema para aplicar completamente."
